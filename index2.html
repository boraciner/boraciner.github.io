<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="title icon" type="image/png" href="images/logo.png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>Pontis EMC | FoE-Charger Firmware</title>
    <script src="https://kit.fontawesome.com/ee6ade3482.js" crossorigin="anonymous"></script>
    
    <style>
      .fade-in{
        opacity: 0;
        animation: fade-in-animation 1s forwards;
      }
      @keyframes fade-in-animation{
        0%{
          opacity:0;
        }
        75%{
          opacity:.8;
        }
        100%{
          opacity:1;
        }
      }


      .slide-in-elliptic-top-fwd {
        animation: slide-in-elliptic-top-fwd 2s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;
      }
      
      @keyframes slide-in-elliptic-top-fwd {
        0% {
          transform: translateY(-600px) rotateX(-30deg) scale(0);
          transform-origin: 50% 100%;
          opacity: 0;
        }
        100% {
          transform: translateY(0) rotateX(0) scale(1);
          transform-origin: 50% 1400px;
          opacity: 1;
        }
      }

      .puff-in-center {
          animation: puff-in-center 0.7s cubic-bezier(0.470, 0.000, 0.745, 0.715) both;
      }
      @keyframes puff-in-center {
        0% {
          transform: scale(2);
          filter: blur(4px);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          filter: blur(0px);
          opacity: 1;
        }
      }

      .carousel-control-next-icon:after
      {
        content: '>';
        font-size: 55px;
        color: blue;
      }

      .carousel-control-prev-icon:after {
        content: '<';
        font-size: 55px;
        color: blue;
      }


      .roll-in-left {
        animation: roll-in-left 0.6s ease-out both;
      }

      @keyframes roll-in-left {
        0% {
          transform: translateX(800px) rotate(540deg);
          opacity: 0;
        }
        100% {
          transform: translateX(0) rotate(0deg);
          opacity: 1;
        }
      }

      .slide-in-blurred-top {
        animation: slide-in-blurred-top 0.6s cubic-bezier(0.230, 1.000, 0.320, 1.000) both;
      }

      @keyframes slide-in-blurred-top {
        0% {
          transform: translateY(-1000px) scaleY(2.5) scaleX(0.2);
          transform-origin: 50% 0%;
          filter: blur(40px);
          opacity: 0;
        }
        100% {
          transform: translateY(0) scaleY(1) scaleX(1);
          transform-origin: 50% 50%;
          filter: blur(0);
          opacity: 1;
        }
      }  

      .fade-out {
        animation: fade-out 1s ease-out both;
      }
      @keyframes fade-out {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>

    
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <a class="navbar-brand" href="#"><i class="fas fa-wave-square fa-2x"></i></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link" href="#">Pontis EMC</a>
          </div>
        </div>
    </nav>
    
    <div class="container-fluid ">
      
      <!--Logo and welcome text begin-->
      <div class="row justify-content-start ">
        <div class="col-lg-2 col-md-4 col-sm-12">    
          <div class="puff-in-center m-3 ">
            <img src="images/logo.png" class="rounded float-left" alt="...">
          </div>
        </div>
        <div class="col-lg-8 col-md-4 col-sm-12">    
          <div class="shadow-lg p-3 m-5 text-primary text-center bg-white rounded">Welcome To FoE-Charger Firmware Upgrade Website</div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-12">    
          <div class="puff-in-center m-3 ">
            <img src="images/Audivo.png" class="rounded float-left" alt="...">
          </div>
        </div>
      </div>

      <!--Logo and welcome text end-->



      <div class="row justify-content-start ">
        <div class="col-lg-3 col-md-8 col-sm-12">
            <button type="button" id="connectButton" class="btn btn-success btn-lg fade-in">
              <i class="fab fa-usb"></i>
              Connect
            </button>
        </div>
        <div class="col-lg-4 col-md-6 col-sm-6 mt-2">
          <ul class="list-group deviceInfoList d-none fade-in">
            <li class="list-group-item bg-warning">Device Information:</li>
            <li class="productName list-group-item"></li>
            <li class="manufacturerName list-group-item"></li>
          </ul>
        </div>
        <div class="col-lg-3 col-md-6 col-sm-3 mt-2">
          <div class="btn-group-vertical">
            <button type="button" id="readPibButton" class="btn btn-primary d-none text-left fade-in" ><i class="fas fa-microchip"></i> Read PIB</button>
            <button type="button" id="writePibButton" class="btn btn-secondary d-none text-left fade-in" disabled><i class="fas fa-pen-square"></i> Write PIB</button>
            <button type="button" id="upgradeApplicationButton" class="btn btn-primary d-none text-left fade-in" ><i class="fas fa-business-time"></i> Upgrade Application</button>
            <button type="button" id="upgradeFirmwareButton" class="btn btn-secondary d-none text-left fade-in" disabled><i class="fas fa-wrench"></i> Upgrade Firmware</button>
          </div>
        </div>
      </div>
      
      <div class="row justify-content-center text-center mt-4 fade-in d-none rawGeneralPIBData">
        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-6">     
          <div class="alert alert-danger generalInfo" role="alert">
            PIB Version : <span id="pibVersion" class="text-secondary">0.0</span>
          </div>
      </div>
      <div class="col-xl-3 col-lg-3 col-md-4 col-sm-6">
        <div class="alert alert-success pevEvseInfo" role="alert">
          Side : <span id="pevEvseSideText" class="text-secondary "></span>
        </div>
      </div>
    </div>
    <hr class="generalInfoDivider2  fade-in d-none"/>
    <!---Main Menu Start-->
    <div class="row justify-content-center text-center  mt-4 fade-in  d-none MainMenuButtons">
      <div class="col-xl-8 col-lg-8 col-md-4 col-sm-6">
        <div class="btn-group" role="group" aria-label="Basic example">
          <button type="button" class="btn btn-outline-primary">Local Device Config</button>
          <button type="button" class="btn btn-outline-danger">PEV / EVSE Configuration</button>
        </div>
      </div>
    </div>
    <!---Main Menu End-->

  </div>


  <div class="container-fluid  applicationUpdatePage d-none mt-5 fade-in">
    <div class="row justify-content-center  ">
      <div class="col-lg-4 col-md-4 col-sm-8">   
        <div class="input-group">
          <div class="custom-file">
            <input type="file" class="custom-file-input" id="inputGroupFile04" aria-describedby="inputGroupFileAddon04">
            <label class="custom-file-label" for="inputGroupFile04">Choose Application Firmware File</label>
          </div>
          <div class="input-group-append">
            <button class="btn btn-primary" type="button" id="inputGroupFileAddon04">Upgrade From File</button>
          </div>
        </div>      
      </div>
      <div class="col-lg-2 col-md-1 col-sm-1">
        <div class="spinner-border text-danger d-none" role="status" id="fileIsLoading">
          <span class="sr-only">Loading...</span>
        </div>
      </div>   
    </div>
    <div class="row justify-content-center  mt-3" style="width:100%">
      <div class="col-lg-4 col-md-4 col-sm-8">   
        <button class="btn btn-primary" type="button" id="inputGroupFileAddon05" style="width:100%">Upgrade Online</button>
      </div>
      <div class="col-lg-2 col-md-1 col-sm-1">
        
      </div>
    </div>
    
    
    <div class="row justify-content-center mt-3">
      <div class="col-lg-4 col-md-4 col-sm-8 text-capitalize badge badge-primary text-wrap d-none " id="transferredOfString" style="width:100%">
        Transferred <span id="sentBytes"></span> of <span id="totalBytes"></span>
      </div>
      <div class="col-lg-2 col-md-1 col-sm-1">
        
      </div> 
    </div>
  </div>

  
  

    <div id="carouselExampleIndicators" class="carousel slide m-5 d-none" data-interval="false">
    <div class="carousel-inner">
      <div class="carousel-item active" data-interval="false">
       <!--MAC MFG Start------------------------------------------------------------------------------------->
            <div class="container-fluid  mt-4  fade-in pageGeneralInfo ">
              <div class="row justify-content-center text-center">
              <div class="col-lg-4 col-sm-10">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend ">
                      <span class="input-group-text " id="mac-inputGroup-sizing-sm">MAC</span>
                    </div>
                    <input type="text" class="form-control pibpage1 pibpage1mac" aria-label="" value="" aria-describedby="inputGroup-sizing-sm">
                </div>
              </div>
                <div class="col-lg-4 col-sm-10">
                  <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="mfg-inputGroup-sizing-sm">MFG</span>
                    </div>
                    <input type="text" class="form-control  pibpage1 pibpage1mfg" aria-label="" value="" aria-describedby="inputGroup-sizing-sm">
                  </div>
                </div>
              </div>
              <!--MAC MFG END--> 
              
              <!--DAK NMK Start-->
              <div class="row justify-content-center text-center">
                <div class="col-lg-4 col-sm-10">
                  <p class="text-primary ">DAK : <span id="dak" class="text-secondary  pibpage1 pibpage1dak"></span></p>
                </div>
                <div class="col-lg-4 col-sm-10">
                  <p class="text-primary">NMK : <span id="nmk" class="text-secondary pibpage1 pibpage1nmk"></span></p>
                </div>
              </div>
              <!--DAK NMK Start-->
              
          
              <!--USR NET Start-->
              <div class="row justify-content-center text-center ">
                <div class="col-lg-4 col-sm-10">
                  <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="usr-inputGroup-sizing-sm">USR</span>
                    </div>
                    <input type="text" class="form-control pibpage1 pibpage1usr" aria-label="" value="PEV EMU SIDE" aria-describedby="inputGroup-sizing-sm">
                  </div>
                </div>
                <div class="col-lg-4 col-sm-10"></div>
              </div>
              <!--USR NET END--> 
          
              <!--CCO Selection Coexist Mode Selection Start-->
              <div class="row justify-content-center text-center">
                <div class="col-lg-4 col-sm-10">
                  <p class="text-primary ">CCo Selection : <span id="ccoselection" class="text-secondary pibpage1 pibpage1ccoselection"></span></p>
                </div>
                <div class="col-lg-4 col-sm-10">
                  <p class="text-primary ">Coexist Mode Selection : <span id="coexistmodeselection" class="text-secondary pibpage1 pibpage1coexistmodeselection"></span></p>
                </div>
              </div>
              <!--CCO Selection Coexist Mode Selection End--> 
          
              <!--PL Freq Selection Preffered NID Start-->
              <div class="row justify-content-center text-center">
                <div class="col-lg-4 col-sm-10">
                  <p class="text-primary ">PL Freq Selection : <span id="plfreqselection" class="text-secondary pibpage1 pibpage1plfreqselection"></span></p>
                </div>
                <div class="col-lg-4 col-sm-10">
                  <p class="text-primary ">Preffered NID Start : <span id="prefferednidstart" class="text-secondary pibpage1 pibpage1prefferedNIDStart"></span></p>
                </div>
              </div>
              <!--PL Freq Selection Preffered NID End--> 
          
              
          
          
              <!--AFE Gain AFE Default Start-->
          

              <div class="row justify-content-center text-center mb-5">
                <div class="col-lg-4 col-sm-10">
                  <form>
                    <div class="form-group text-primary">
                      <label for="formControlRange2">AFE Gain : <span id="pibpage1afegain" class="text-secondary"></span></label>
                      <input type="range" class="custom-range" min="-100" max="20" id="formControlRange2" value="0">
                    </div>
                  </form>
                </div>
                <div class="col-lg-4 col-sm-10 mt-3">
                  <button type="button" class="btn btn-dark">AFE Default</button>
                </div>
              </div>
              <!--AFE Gain AFE Default End--------------------------------------------------------------------> 
            </div>
      </div>
      <div class="carousel-item mb-5" data-interval="false">
        <!--MAC MFG Start------------------------------------------------------------------------------------->
        <div class="container-fluid  mt-4  fade-in pageGeneralInfo ">
          <div class="row justify-content-center text-center">
          <div class="col-8">
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <div class="input-group-text">
                  <input type="checkbox" aria-label="Checkbox for following text input" id="FastAVLNAssociate" >
                </div>
              </div>
              <input type="text" class="form-control" aria-label="Text input with checkbox" value="Fast AVLN Associate">
            </div>
            
          </div>
            <div class="col-8">
              <div class="input-group mb-5">
                <div class="input-group-prepend">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="comboboxPevEvse">PEV / EVSE</button>
                  <div class="dropdown-menu" >
                    <a class="dropdown-item">PEV</a>
                    <a class="dropdown-item">EVSE</a>
                  </div>
                </div>
                <input type="text" class="form-control " aria-label="Text input with dropdown button" value="" id="pevEvseSideComboboxText">
              </div>
            </div>
          </div>
         
        </div>
      </div>
     
    </div>
    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>

    
  
     <!--Navigation Buttons End-->

    <div class="fixed-bottom container-fluid text-right">
      <div class="text-primary font-weight-light">Version 0.1</div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  
   

    <script>
      
      const DFU_BLOCK_PLC_PIB_START = 2000;
      const BUFFER_SIZE = 512;
      const DFU_REQ_UPLOAD = 2;
      console.hex = (d) => console.log((Object(d).buffer instanceof ArrayBuffer ? new Uint8Array(d.buffer) : 
                            typeof d === 'string' ? (new TextEncoder('utf-8')).encode(d) : 
                            new Uint8ClampedArray(d)).reduce((p, c, i, a) => p + (i % 16 === 0 ? i.toString(16).padStart(6, 0) + '  ' : ' ') + 
                            c.toString(16).padStart(2, 0) + (i === a.length - 1 || i % 16 === 15 ? 
                            ' '.repeat((15 - i % 16) * 3) + Array.from(a).splice(i - i % 16, 16).reduce((r, v) => 
                            r + (v > 31 && v < 127 || v > 159 ? String.fromCharCode(v) : '.'), '  ') + '\n' : ''), ''));
      class ApplicationUpdater{

        constructor(deviceVar){
          this.device = deviceVar;
          

        }



        Update(myByteArray,blockCounter = 0,askForStatus = false){

          console.log(">>>>Application Updater | Update | blockCounter",blockCounter,"askForStatus", askForStatus)

          if(askForStatus){
            console.log("askForStatus true....")

            let result2 = this.device.controlTransferIn({
              requestType: 'class',
              recipient: 'interface',
              request: 3,
              value: 0,
              index: 0}, 6);
            result2.then(res2=>{
              console.log("RESULT Status of Device ",res2)
              let arrayBuffer = res2.data.buffer;
              let receivedData = new Uint8Array(arrayBuffer);
              console.log(">>> Status ")
              console.hex(receivedData);
              if (receivedData[4] === 0x04 || receivedData[4] === 0x05) {
                console.log(">>> Status stage 1")
                if (receivedData[4] === 0x04)
                {
                  console.log(">>> Status stage 2")
                  let timeout = ((receivedData[2] & 0xff) << 8) | (receivedData[1] & 0xff);
                  setTimeout(() => {
                    console.error("wait for ",timeout," milliseconds")
                    this.Update(myByteArray,blockCounter,true)
                  }, timeout);
                }else{
                  console.log(">>> Status stage 3")
                  console.error("do it now...")
                  this.Update(myByteArray,blockCounter,false)
                }
                
              }else{
                console.error("SIKINTI VAR");
              }
            }) 


          }else{
            console.log("askForStatus false....")
            let myCurrentByteIndex = blockCounter*512;
            let availableNextBytes = 0
            if(myCurrentByteIndex > myByteArray.length){
              console.warn("askForStatus false.... myByteArray.length",myByteArray.length,"myCurrentByteIndex",myCurrentByteIndex," You must handle this")
              availableNextBytes = 0;
            }else if(myByteArray.length >= myCurrentByteIndex+512)
              availableNextBytes = myCurrentByteIndex+512
            else
              availableNextBytes = myByteArray.length; 

            console.log("myCurrentByteIndex",myCurrentByteIndex,"availableNextBytes",availableNextBytes,"total length",myByteArray.length)
            document.getElementById("sentBytes").innerText = myCurrentByteIndex
            document.getElementById("totalBytes").innerText = myByteArray.length
            
            if(availableNextBytes > 0)
            {
              console.log("Write IT ===> FROM ",myCurrentByteIndex, "TO",availableNextBytes);
              console.hex(myByteArray.slice(myCurrentByteIndex,availableNextBytes));

              let result = this.device.controlTransferOut({
              requestType: 'class',
              recipient: 'interface',
              request: 1,
              value: blockCounter,
              index: 0}, myByteArray.slice(myCurrentByteIndex,availableNextBytes));
            
            
              result.then(res=>{
                blockCounter += 1
              
                console.log("RESULT writing BULK ",res)
                if(true){
                  let result2 = this.device.controlTransferIn({
                    requestType: 'class',
                    recipient: 'interface',
                    request: 3,
                    value: 0,
                    index: 0}, 6);
                  result2.then(res2=>{
                    console.log("RESULT Status of Device ",res2)
                    let arrayBuffer = res2.data.buffer;
                    let receivedData = new Uint8Array(arrayBuffer);
                    console.log(">>> Status ")
                    console.hex(receivedData);
                    if (receivedData[4] === 0x04 || receivedData[4] === 0x05) {
                      console.log(">>> Status stage 1")
                      if (receivedData[4] === 0x04)
                      {
                        console.log(">>> Status stage 2")
                        let timeout = ((receivedData[2] & 0xff) << 8) | (receivedData[1] & 0xff);
                        setTimeout(() => {
                          console.log("wait for ",timeout," milliseconds")
                          this.Update(myByteArray,blockCounter,true)
                        }, timeout);
                      }else{
                        console.log(">>> Status stage 3")
                        console.log("do it now...")
                        this.Update(myByteArray,blockCounter,false)
                      }
                      
                    }else{
                      console.error("Something is wrong");
                    }
                  }) 
                }
              })

            }else{
              // Final Stage After finishing Application Firmware
              console.log("Finishing Application Firmware Upload - 1")
              let result = this.device.controlTransferOut({
              requestType: 'class',
              recipient: 'interface',
              request: 1,
              value: blockCounter,
              index: 0}, new Uint8Array());
              result.then(res=>{
                console.log("Finishing Application Firmware Upload - 2")
                let result2 = this.device.controlTransferIn({
                    requestType: 'class',
                    recipient: 'interface',
                    request: 3,
                    value: 0,
                    index: 0}, 6);
                  result2.then(res2=>{
                    console.log("Finishing Application Firmware Upload - 3")
                    let result3 = this.device.controlTransferIn({
                      requestType: 'class',
                      recipient: 'interface',
                      request: 3,
                      value: 0,
                      index: 0}, 6);
                    });
              });
              document.querySelector("#fileIsLoading").classList.add("d-none")
              document.querySelector("#transferredOfString").classList.add("d-none")
              
            }
          }
        }
      };
      
      const NVM_IMAGE_GENERIC             =  0x0000;
      const NVM_IMAGE_CONFIG_SYNOPSIS     =  0x0001;
      const NVM_IMAGE_CONFIG_DENALI       =  0x0002;
      const NVM_IMAGE_APPLET_DENALI       =  0x0003;
      const NVM_IMAGE_FIRMWARE            =  0x0004;
      const NVM_IMAGE_OASCLIENT           =  0x0005;
      const NVM_IMAGE_CUSTOM              =  0x0006;
      const NVM_IMAGE_MEMCTL              =  0x0007;
      const NVM_IMAGE_ADVPWRMGMT          =  0x0008;
      const NVM_IMAGE_OAS_CLIENT_IP_STK   =  0x0009;
      const NVM_IMAGE_OAS_CLIENT_TR069    =  0x000A;
      const NVM_IMAGE_NVM_SOFTLOADER      =  0x000B;
      const NVM_IMAGE_FLASH_LAYOUT        =  0x000C;
      const NVM_IMAGE_MANIFEST            =  0x000E;
      const NVM_IMAGE_PIB                 =  0x000F;
      class PIBManager{
         
        constructor(deviceVar){
          this.device = deviceVar;
          this.pibContent = new Uint8Array();
          this.pibVersionString = ""
          this.MAC_Uint8Arr = new Uint8Array();
          this.DAK_Uint8Arr = new Uint8Array();
          this.MFG_Str = ""
          this.NMK_Uint8Arr = new Uint8Array();
          this.USR_Str = ""
          this.NET_Str = ""
          this.CCoSelection = 0;
          this.CoexistModeSelection = new Uint8Array();
          this.PLFreqSelection = new Uint8Array();
          this.PreferredNID_Uint8Arr = new Uint8Array();
          this.AutoFWUpgradeable = new Uint8Array();
          this.MDUConfiguration = new Uint8Array();
          this.MDURole = new Uint8Array();
          this.CommunicationsMedia = new Uint8Array();
          this.AFEGain = new Uint8Array();
          this.AFEGainNumber = 0
        }

        PrepareSpecialHexString(hexArray){
          let strtmp = "";
          hexArray.forEach(element=>{
          if(element < 10)
            strtmp += "0" + element.toString(16) + ":"
          else
            strtmp += element.toString(16) + ":"
          });
          strtmp = strtmp.slice(0,strtmp.length-1)  
          return strtmp.toUpperCase();
        }
        
        convert_u32(Uint8Arr) {
            Uint8Arr = Uint8Arr.reverse();
            let view = new DataView(Uint8Arr.buffer)

            return view.getUint32();
        }

        convert_u16(Uint8Arr) {
            Uint8Arr = Uint8Arr.reverse();
            let view = new DataView(Uint8Arr.buffer)

            return view.getUint16();
        }

        convert_u8(Uint8Arr) {
            Uint8Arr = Uint8Arr.reverse();
            let view = new DataView(Uint8Arr.buffer)

            return view.getUint8();
        }        

        convert_32(Uint8Arr) {
            Uint8Arr = Uint8Arr.reverse();
            let view = new DataView(Uint8Arr.buffer)

            return view.getInt32();
        }

        convert_16(Uint8Arr) {
            Uint8Arr = Uint8Arr.reverse();
            let view = new DataView(Uint8Arr.buffer)

            return view.getInt16();
        }

        convert_8(Uint8Arr) {
            Uint8Arr = Uint8Arr.reverse();
            let view = new DataView(Uint8Arr.buffer)

            return view.getInt8();
        } 

        concatTypedArrays(a, b) { // a, b TypedArray of same type
            var c = new (a.constructor)(a.length + b.length);
            c.set(a, 0);
            c.set(b, a.length);
            return c;
        }

        async readPibData(){
          let blockCounter = 0;
          let responseLength = 0;
          do{
            let result = await this.device.controlTransferIn({
                requestType: 'class',
                recipient: 'interface',
                request: 2,
                value: DFU_BLOCK_PLC_PIB_START + blockCounter,
                index: 0}, 512);
            if (result.status !== 'ok')
              return null;
            
            let arrayBuffer = result.data.buffer;
            let my8buf = new Uint8Array(arrayBuffer);

            this.pibContent = this.concatTypedArrays(this.pibContent,my8buf);
            console.warn("concated length : ",this.pibContent.length);
            responseLength = my8buf.length; 
            //console.log("Received my8buf :",my8buf,"length ",my8buf.length)
            blockCounter++;
          }while(responseLength == 512);

          this.parsePIBBlocks(this.pibContent);

        }
        ParseImagePib(pibBlockByteArr){
          console.log("Parse Image PIB")
          
          let header = pibBlockByteArr.slice(0 ,96)
          let data = pibBlockByteArr.slice(96 ,pibBlockByteArr.length)
          console.hex(header)
          console.hex(data)

          this.MAC_Uint8Arr = data.slice(12 ,18)
          this.DAK_Uint8Arr = data.slice(18 , 34)
          this.MFG_Str = (new TextDecoder("utf-8").decode(data.slice(36,100))).replace(/[^a-z0-9]/gmi, " ").replace(/\s+/g, " ").trim();
          this.NMK_Uint8Arr = data.slice(100 , 116)
          this.USR_Str = (new TextDecoder("utf-8").decode(data.slice(116,180))).replace(/[^a-z0-9]/gmi, " ").replace(/\s+/g, " ").trim();
          this.NET_Str = (new TextDecoder("utf-8").decode(data.slice(180,244))).replace(/[^a-z0-9]/gmi, " ").replace(/\s+/g, " ").trim();
          this.CCoSelection = (data.slice(244 , 245)[0])
          this.CoexistModeSelection = data.slice(245 , 246)
          this.PLFreqSelection = data.slice(246 , 247)
          this.PreferredNID_Uint8Arr = data.slice(248 , 255)
          this.AutoFWUpgradeable = data.slice(256 , 257)
          this.MDUConfiguration = data.slice(257 , 258)
          this.MDURole = data.slice(258 , 259)
          this.CommunicationsMedia = data.slice(266 , 267)
          this.AFEGain = data.slice(5233 , 5237)
          this.AFEGainNumber = this.convert_32(this.AFEGain)
          this.SlacEnable = (data.slice(5715 , 5716)[0])
          this.FastAVLNAssociate = ((data.slice(5843 , 5844)[0]))


        }
        ParseImageManifest(manifestBlockByteArr){
          console.log("Parse Image Manifest")
          //console.hex(manifestBlockByteArr)

          let header = manifestBlockByteArr.slice(0 ,96)
          let data = manifestBlockByteArr.slice(96 ,manifestBlockByteArr.length)
          console.hex(header)
          console.hex(data)
          

          this.pibVersionString = new TextDecoder("utf-8").decode(manifestBlockByteArr.slice(512,534));
          console.log("pibVersionString ",this.pibVersionString)


        }
        parsePIBBlocks(myByteArray){
            
            
            let HeaderAddress = 0
            do{
                //Next Header Address
                let HeaderAddressArr = myByteArray.slice(HeaderAddress + 28 ,HeaderAddress + 32);
                //Block Size
                let ImageLength = this.convert_u32(myByteArray.slice(HeaderAddress + 16 ,HeaderAddress + 20))
                //Image Type
                let imageType = this.convert_u32(myByteArray.slice(HeaderAddress + 36 ,HeaderAddress + 40))
                console.log("HeaderAddress:" ,HeaderAddress," Header Size : 96 ","ImageLength",ImageLength, " Block Size :",(ImageLength+96));
                console.warn("imageType:" ,imageType);
                
                switch(imageType){
                  case NVM_IMAGE_PIB:
                    this.ParseImagePib(myByteArray.slice(HeaderAddress,ImageLength+96));
                    break;
                  case NVM_IMAGE_MANIFEST:
                    this.ParseImageManifest(myByteArray.slice(HeaderAddress,ImageLength+96));
                    break;
                }
                
                HeaderAddress = this.convert_32(HeaderAddressArr)
            }while(HeaderAddress > 0)
            
            console.log("Total PIB File Length:" + myByteArray.length);
        }

        getPibVersionString(){
            return this.pibVersionString;
        }
      };

        navigator.usb.addEventListener('connect', event => {
            console.log("navigator.usb.addEventListener(connect");
        });

        navigator.usb.addEventListener('disconnect', event => {
            console.log("navigator.usb.addEventListener(disconnect");
            DisconnectProcessUI();
        });


        let pageGeneralInfoElement = document.querySelector(".pageGeneralInfo");
        let rawGeneralPIBDataElement = document.querySelector(".rawGeneralPIBData");
        let generalInfoDividerElement = document.querySelector(".generalInfoDivider");
        let generalInfoDividerElement2 = document.querySelector(".generalInfoDivider2");
        let MainMenuButtonsElement = document.querySelector(".MainMenuButtons");
        let carouselExampleIndicatorsElement = document.querySelector("#carouselExampleIndicators");

        let connectButtonElement = document.querySelector("#connectButton");
        let readPibButtonElement = document.querySelector("#readPibButton");
        let writePibButtonElement = document.querySelector("#writePibButton");
        let upgradeFirmwareButtonElement = document.querySelector("#upgradeFirmwareButton");
        let upgradeApplicationButtonElement = document.querySelector("#upgradeApplicationButton");
        let deviceInfoListElement = document.querySelector(".deviceInfoList");
        let productNameElement = document.querySelector(".productName");
        let manufacturerNameElement = document.querySelector(".manufacturerName");
        let applicationUpdatePageElements = document.querySelectorAll(".applicationUpdatePage")
        
        var intervalVar;
        var device;

        let pibManager = {};
        let applicationUpdater = {};
        function httpGet(theUrl)
        {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
            xmlHttp.send( null );
            return xmlHttp.responseText;
        }
        let file = "";
        document.getElementById('inputGroupFileAddon05').onclick = function(){
          let response = httpGet("https://wasp1.free.beeceptor.com/")
          var responseArr = new Uint8Array(response.split(", ").map(x=>parseInt(x,16)))
          
          console.log("responseArr : ",responseArr)
          document.querySelector("#fileIsLoading").classList.remove("d-none")
          document.querySelector("#transferredOfString").classList.remove("d-none")
          applicationUpdater.Update(responseArr)
           
        };

        document.getElementById('inputGroupFileAddon04').onclick = function(){
          if(file!==""){ 
            let reader = new FileReader();
            reader.onload = function(progressEvent){
              console.log("Pressed 3")
              let arrayBuffer = reader.result
              let bytes = new Uint8Array(arrayBuffer);
              
              
              console.log("Pressed 4")
              document.querySelector("#fileIsLoading").classList.remove("d-none")
              document.querySelector("#transferredOfString").classList.remove("d-none")
              applicationUpdater.Update(bytes)
              console.log("Pressed ==========================================")
            };
            console.log("Pressed 1")
            reader.readAsArrayBuffer(file);
            console.log("Pressed 2")
          }
        };
        document.getElementById('inputGroupFile04').onchange = function(){
          console.log("File is selected")
          file = this.files[0];
        };

        function DisconnectProcessUI(){
            connectButtonElement.innerHTML  = "<i class=\"fab fa-usb\"></i> Connect"; 
            connectButtonElement.classList.add("btn-success")
            connectButtonElement.classList.remove("btn-danger")
            
            deviceInfoListElement.classList.add("d-none")
            readPibButton.classList.add("d-none")
                
            readPibButtonElement.classList.add("d-none")
            writePibButtonElement.classList.add("d-none")
            upgradeFirmwareButtonElement.classList.add("d-none")
            upgradeApplicationButtonElement.classList.add("d-none")
            document.querySelector("#fileIsLoading").classList.add("d-none")
            document.querySelector("#transferredOfString").classList.add("d-none")
            HideReadPIBPage();
            HideApplicationFirmwareUpdatePage();
            
        }
        function ConnectProcessUI(){
            deviceInfoListElement.classList.remove("d-none")
            productNameElement.innerHTML  = device.productName; 
            manufacturerNameElement.innerHTML  = device.manufacturerName;

            connectButtonElement.innerHTML  = "<i class=\"fab fa-usb\"></i> Disconnect"; 
            connectButtonElement.classList.remove("btn-success")
            connectButtonElement.classList.add("btn-danger")

            readPibButton.classList.remove("d-none")


                
            readPibButtonElement.classList.remove("d-none")
            writePibButtonElement.classList.remove("d-none")
            upgradeFirmwareButtonElement.classList.remove("d-none")
            upgradeApplicationButtonElement.classList.remove("d-none")
            
        }

        function FillPIBPage(pibManager){
          document.querySelector("#pibVersion").innerHTML  = pibManager.getPibVersionString();
          document.querySelector(".pibpage1mac").value = pibManager.PrepareSpecialHexString(pibManager.MAC_Uint8Arr)
          document.querySelector(".pibpage1dak").innerText = pibManager.PrepareSpecialHexString(pibManager.DAK_Uint8Arr)
          document.querySelector(".pibpage1nmk").innerText = pibManager.PrepareSpecialHexString(pibManager.NMK_Uint8Arr)
          document.querySelector(".pibpage1mfg").value = pibManager.MFG_Str.trim()
          document.querySelector(".pibpage1usr").value = pibManager.USR_Str.trim()
          let ccoSelectionCase = pibManager.CCoSelection;
          let tmpStr = ""
          switch(ccoSelectionCase){
            case 0:
              tmpStr = "Auto"
              break;
            case 1:
              tmpStr = "Never"
              break;
            case 2:
              tmpStr = "Always"
              break;
            case 3:
              tmpStr = "User Assigned"
              break;
          }
          document.querySelector(".pibpage1ccoselection").innerHTML = tmpStr
          document.querySelector(".pibpage1coexistmodeselection").innerHTML = pibManager.CoexistModeSelection
          document.querySelector(".pibpage1plfreqselection").innerHTML = pibManager.PLFreqSelection
          document.querySelector(".pibpage1prefferedNIDStart").innerText = pibManager.PrepareSpecialHexString(pibManager.PreferredNID_Uint8Arr)
          document.querySelector("#pibpage1afegain").innerHTML = pibManager.AFEGainNumber
          document.querySelector("#formControlRange2").value = pibManager.AFEGainNumber
          let pevEvseStr = ""
          switch(pibManager.SlacEnable){
            case 1:
              pevEvseStr = "PEV";
              break;
            case 2:
              pevEvseStr = "EVSE";
              break;
            default:
              pevEvseStr = "Error";
              break;
          }
          document.querySelector("#pevEvseSideText").innerHTML = pevEvseStr;
          document.querySelector("#pevEvseSideComboboxText").value = pevEvseStr;
          if(this.FastAVLNAssociate == 1){
            document.querySelector("#FastAVLNAssociate").checked = true
          }else{
            document.querySelector("#FastAVLNAssociate").checked = false
          }
        }

        function ShowReadPIBPage(){
          pageGeneralInfoElement.classList.remove("d-none");
          rawGeneralPIBDataElement.classList.remove("d-none");
          MainMenuButtonsElement.classList.remove("d-none");
          carouselExampleIndicatorsElement.classList.remove("d-none");
        }

        function HideReadPIBPage(){
          pageGeneralInfoElement.classList.add("d-none");
          rawGeneralPIBDataElement.classList.add("d-none");
          MainMenuButtonsElement.classList.add("d-none");
          carouselExampleIndicatorsElement.classList.add("d-none");
        }

        function ShowApplicationFirmwareUpdatePage(){
          
          HideReadPIBPage();

          applicationUpdatePageElements.forEach(element=>{
            element.classList.remove("d-none");
          });
        }

        function HideApplicationFirmwareUpdatePage(){
          applicationUpdatePageElements.forEach(element=>{
            element.classList.add("d-none");
          });
        }

    

        upgradeApplicationButtonElement.addEventListener("click",async function(event){
          console.log("upgradeApplicationButtonElement is clicked! start");

          ShowApplicationFirmwareUpdatePage();
          console.log("upgradeApplicationButtonElement is clicked! end");
        });

        connectButtonElement.addEventListener("click",async function(event){
          if(connectButtonElement.innerHTML.includes("Disconnect")){
            DisconnectProcessUI();
          }  
          else{
            try {
              device = await navigator.usb.requestDevice({ filters: [{
                  vendorId: 2492
              }]});
            } catch (err) {
                device = undefined;
            }
           
            if (device !== undefined) {
                await device.open();
                if (device.configuration === null)
                {
                    console.log("device.configuration === null");
                    await device.selectConfiguration(0);
                }else{
                    console.log("device.configuration != null");
                }
                await device.claimInterface(0);

                pibManager = new PIBManager(device);
                applicationUpdater = new ApplicationUpdater(device);

                ConnectProcessUI();
            }
          }
        });




      readPibButtonElement.addEventListener("click",async function(event){
        ShowReadPIBPage();
        HideApplicationFirmwareUpdatePage();
        await pibManager.readPibData();
        FillPIBPage(pibManager);
      });


    </script>


    </body>
</html>
