<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="title icon" type="image/png" href="images/logo.png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>Pontis EMC | FoE-Charger Firmware</title>
    <script src="https://kit.fontawesome.com/ee6ade3482.js" crossorigin="anonymous"></script>
  </head>
  <body>

    
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <a class="navbar-brand" href="#"><i class="fas fa-wave-square fa-2x"></i></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link" href="#">Pontis EMC</a>
          </div>
        </div>
    </nav>

    <div class="shadow-lg p-3 m-5 text-primary text-center bg-white rounded">Welcome To FoE-Charger Firmware Upgrade Website</div>
    
    <p class="lead m-3">Please Follow the Instructions</p>

    <div class="container-fluid">
      <div class="row justify-content-start">
        <div class="col-4">
            <button type="button" id="connectButton" class="btn btn-success btn-lg ">
              <i class="fab fa-usb"></i>

              Connect
            </button>  
        </div>
        <div class="col-8">
          <ul class="list-group deviceInfoList d-none">
            <li class="list-group-item bg-info">Device Information:</li>
            <li class="productName list-group-item"></li>
            <li class="manufacturerName list-group-item"></li>
          </ul>
        </div>
      </div>
      <div class="row"><br></div>
      <div class="row">
        <div class="col-3">
          <div class="btn-group-vertical  ">
            <button type="button" id="readPibButton" class="btn btn-secondary d-none text-left" disabled><i class="fas fa-microchip"></i> Read PIB</button>
            <button type="button" id="writePibButton" class="btn btn-secondary d-none text-left" disabled><i class="fas fa-pen-square"></i> Write PIB</button>
            <button type="button" id="upgradeFirmwareButton" class="btn btn-secondary d-none text-left" disabled><i class="fas fa-wrench"></i> Upgrade Firmware</button>
          </div>
        </div>
        <div class="col-9 ">
          <div class="progress d-none">
            <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            
          </div>
          <p class="loadingInfo text-right font-italic"></p>
        </div>
      </div>
    </div>
    
    <div class="fixed-bottom container-fluid text-right">
      
      <div class="text-primary font-weight-light">Version 0.1</div>
   
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  
   

    <script>
      const DFU_BLOCK_PLC_PIB_START = 2000;
      const BUFFER_SIZE = 512;
      const DFU_REQ_UPLOAD = 2;

      class PIBManager{
        
        constructor(deviceVar){
          this.device = deviceVar;
          this.blockCounter = DFU_BLOCK_PLC_PIB_START;

          this.device.selectConfiguration(1)
          .then(() => this.device.claimInterface(0))
          .then(()=> {console.log("Claimed!")})
          .then(() => this.device.controlTransferOut({
              requestType: 'class',
              recipient: 'interface',
              request: DFU_REQ_UPLOAD,
              value: blockCounter,
              index: 0})) // Ready to receive data
          .then(
            () =>{
              console.log("Ready to receive data")
              this.device.transferIn(0, BUFFER_SIZE)
              }) // Waiting for 64 bytes of data from endpoint #5.
          .then(result => {
            let decoder = new TextDecoder();
            console.log('Received: ' + decoder.decode(result.data));
          })
          .catch(error => { console.log(error); });
        }

        printDevice(){
          console.log("this.device",this.device.productName);
          console.log("this.device",this.device.manufacturerName);
        }

        bootloaderReadData(){

        }




      };

      var pibManager = {};

        let connectButtonElement = document.querySelector("#connectButton");
        let readPibButtonElement = document.querySelector("#readPibButton");
        let writePibButtonElement = document.querySelector("#writePibButton");
        let upgradeFirmwareButtonElement = document.querySelector("#upgradeFirmwareButton");
        let progressElement = document.querySelector(".progress");
        let progressBarElement = document.querySelector(".progress-bar");
        let loadingInfoElement = document.querySelector(".loadingInfo");
        
        let deviceInfoListElement = document.querySelector(".deviceInfoList");
        let productNameElement = document.querySelector(".productName");
        let manufacturerNameElement = document.querySelector(".manufacturerName");

        let connected = false;
        var intervalVar;


        connectButtonElement.addEventListener("click",function(event){
          
          if(connected){
            this.innerHTML  = "<i class=\"fab fa-usb\"></i> Connect"; 
            this.classList.add("btn-success")
            this.classList.remove("btn-danger")


            
            deviceInfoListElement.classList.add("d-none")
            readPibButton.classList.add("d-none", "btn-secondary")
            readPibButton.setAttribute("disabled","")
            readPibButton.classList.remove("btn-primary")
                
            readPibButtonElement.classList.add("d-none")
            writePibButtonElement.classList.add("d-none")
            upgradeFirmwareButtonElement.classList.add("d-none")

            connected = !connected;

          }  
          else{
            
            navigator.usb.requestDevice({ filters: [/*{ vendorId: 2492 }*/] })
            .then(selectedDevice => {
              device = selectedDevice;
              return device.open(); // Begin a session.
            })
            .then(() => device.selectConfiguration(1)) // Select configuration #1 for the device.
            .then(() => device.claimInterface(0)) // Request exclusive control over interface #2.
            .then(() => device.controlTransferOut({
              requestType: 'class',
              recipient: 'interface',
              request: 0x22,
              value: 0x01,
              index: 0x02})) // Ready to receive data
          .then(() => device.transferIn(5, 64)) // Waiting for 64 bytes of data from endpoint #5. 
            .then(result => {
              
              console.log('Received: ' + result.data);
            })
            .catch(error => { console.log(error); });
            /*navigator.usb.requestDevice({ filters: [{ vendorId: 2492  }] })
            .then(device => {
            
              deviceInfoListElement.classList.remove("d-none")
              productNameElement.innerHTML  = device.productName; 
              manufacturerNameElement.innerHTML  = device.manufacturerName;

              this.innerHTML  = "<i class=\"fab fa-usb\"></i> Disconnect"; 
              this.classList.remove("btn-success")
              this.classList.add("btn-danger")

              readPibButton.classList.remove("d-none", "btn-secondary")
              readPibButton.removeAttribute("disabled")
              readPibButton.classList.add("btn-primary")
                  
              readPibButtonElement.classList.remove("d-none")
              writePibButtonElement.classList.remove("d-none")
              upgradeFirmwareButtonElement.classList.remove("d-none")
              connected = !connected; 
              return device;
           }).then(device => {

            console.log("device.productName",device.productName);
            console.log("device.productName",device.manufacturerName);
            pibManager = new PIBManager(device);
            pibManager.printDevice();



           })
           .catch(error => { console.log(error); });
          */


            
          }

          
        });

        let percentage = 0;
        readPibButtonElement.addEventListener("click",function(event){
          progressElement.classList.remove("d-none");
          
          if(intervalVar)
            clearInterval(intervalVar);


          console.log("Set Interval")
          intervalVar = setInterval(function(){ 
            percentage++;
            if(percentage > 100)
              return;

            progressBarElement.setAttribute("aria-valuenow",String(percentage));
            progressBarElement.setAttribute("style","width: "+String(percentage)+"%");
            
            if(percentage<30){
              loadingInfoElement.innerText = "Phase 1";
            }else if(percentage<60){
              loadingInfoElement.innerText = "Phase 2";
            }else if(percentage<101){
              loadingInfoElement.innerText = "Completed!";
            }   
            loadingInfoElement



            if(percentage == 100){
              console.log("Set Timeout")
              setTimeout(()=>{

                console.log("TIMEOUTTTTTTTTTTTTT")
                progressElement.classList.add("d-none");
                loadingInfoElement.innerText = "";
                clearInterval(intervalVar);
                percentage = 0;
                progressBarElement.setAttribute("aria-valuenow",String(percentage));
                progressBarElement.setAttribute("style","width: "+String(percentage)+"%");
              },2000);
              
            }
           
          }, 50);
        });

    </script>


    </body>
</html>
